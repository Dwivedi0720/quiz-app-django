{% extends 'base.html' %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="container">

        <!-- PAGE TITLE -->
        <h1 class="page-title">ğŸ‘¨â€ğŸ“ Student Dashboard</h1>

        <!-- STATS -->
        <div class="grid grid-4">
            <div class="stats-card">
                <div class="stats-icon">ğŸ“</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_attempted }}</div>
                <div class="stats-label">Total Quizzes</div>
            </div>

            <div class="stats-card">
                <div class="stats-icon">âœ…</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_passed }}</div>
                <div class="stats-label">Passed</div>
            </div>

            <div class="stats-card">
                <div class="stats-icon">âŒ</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_failed }}</div>
                <div class="stats-label">Failed</div>
            </div>

            <div class="stats-card">
                <div class="stats-icon">ğŸ¯</div>
                <div class="stats-number">
                    {{ overall_progress.overall_percentage|floatformat:1 }}%
                </div>
                <div class="stats-label">Average Score</div>
            </div>
        </div>

        <!-- CHART + RECENT -->
        <div class="grid grid-2 mt-4">

            <!-- PERFORMANCE CHART -->
            <div class="card">
                <h3 class="card-title">ğŸ“Š Performance Trend (Last 30 Days)</h3>
                <canvas id="performanceChart" height="180"></canvas>
            </div>

            <!-- RECENT ATTEMPTS -->
            <div class="card">
                <h3 class="card-title">ğŸ“ˆ Recent Attempts</h3>

                {% if recent_attempts %}
                    {% for attempt in recent_attempts %}
                    <div class="recent-attempt-item">
                        <div class="attempt-left">
                            <h4>{{ attempt.quiz.title }}</h4>
                            <span class="attempt-date">
                                {{ attempt.end_time|date:"M d, Y - H:i" }}
                            </span>
                        </div>

                        <div class="attempt-right">
                            <span class="attempt-score
                                {% if attempt.is_passed %}score-pass{% else %}score-fail{% endif %}">
                                {{ attempt.percentage|floatformat:0 }}%
                            </span>

                            <a href="{% url 'quiz:quiz_result' attempt.id %}"
                               class="btn btn-outline btn-sm">
                                View
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty-text">No quiz attempts yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- DAILY PROGRESS -->
        <div class="card mt-4">
            <h3 class="card-title">ğŸ“… Daily Progress</h3>

            {% if daily_progress %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Attempts</th>
                            <th>Passed</th>
                            <th>Failed</th>
                            <th>Average %</th>
                            <th>Time Spent</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dp in daily_progress %}
                        <tr>
                            <td>{{ dp.date|date:"M d, Y" }}</td>
                            <td>{{ dp.quizzes_attempted }}</td>
                            <td class="text-success">{{ dp.quizzes_passed }}</td>
                            <td class="text-danger">{{ dp.quizzes_failed }}</td>
                            <td><strong>{{ dp.average_percentage|floatformat:1 }}%</strong></td>
                            <td>{{ dp.time_spent|floatformat:0 }}s</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="empty-text">No daily progress data available.</p>
            {% endif %}
        </div>

    </div>
</div>

<!-- CHART JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('performanceChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_dates|safe }},
        datasets: [{
            data: {{ chart_percentages|safe }},
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56,189,248,0.15)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, max: 100 }
        }
    }
});
</script>
{% endblock %}
