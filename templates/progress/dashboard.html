{% extends 'base.html' %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div style="padding: 4rem 0;">
    <div class="container">
        <h1 style="color: white; margin-bottom: 2rem;">üë®‚Äçüéì Welcome, {{ user.get_full_name }}</h1>

        <!-- Overall Statistics -->
        <div class="grid grid-4" style="margin-bottom: 2rem;">
            <div class="stats-card">
                <div class="stats-icon">üìù</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_attempted }}</div>
                <div class="stats-label">Total Quizzes</div>
            </div>
            <div class="stats-card">
                <div class="stats-icon">‚úÖ</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_passed }}</div>
                <div class="stats-label">Passed</div>
            </div>
            <div class="stats-card">
                <div class="stats-icon">‚ùå</div>
                <div class="stats-number">{{ overall_progress.total_quizzes_failed }}</div>
                <div class="stats-label">Failed</div>
            </div>
            <div class="stats-card">
                <div class="stats-icon">üéØ</div>
                <div class="stats-number">{{ overall_progress.overall_percentage|floatformat:1 }}%</div>
                <div class="stats-label">Avg Score</div>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- Performance Chart -->
            <div class="card">
                <div class="card-header">
                    <h3>üìä Performance Trend (Last 30 Days)</h3>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3>üìà Recent Attempts</h3>
                </div>
                <div class="card-body">
                    {% if recent_attempts %}
                    <div style="max-height: 350px; overflow-y: auto;">
                        {% for attempt in recent_attempts %}
                        <div style="padding: 1rem; border-bottom: 1px solid var(--light); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">{{ attempt.quiz.title }}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">{{ attempt.end_time|date:"M d, Y - H:i" }}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: {% if attempt.is_passed %}var(--success){% else %}var(--danger){% endif %};">
                                    {{ attempt.percentage|floatformat:0 }}%
                                </div>
                                <a href="{% url 'quiz:quiz_result' attempt.id %}" class="btn btn-sm btn-info" style="margin-top: 0.5rem;">View</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>No attempts yet. Start taking quizzes!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Available Quizzes -->
        {% if available_quizzes %}
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3>üöÄ Available Quizzes</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-3">
                    {% for quiz in available_quizzes %}
                    <div class="quiz-card">
                        <h4>{{ quiz.title }}</h4>
                        <p style="color: #6b7280; font-size: 0.875rem;">{{ quiz.description|truncatewords:10 }}</p>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
                            <span>üìù {{ quiz.total_questions }}Q</span>
                            <span>üéØ {{ quiz.total_marks }}M</span>
                        </div>
                        <a href="{% url 'quiz:quiz_detail' quiz.id %}" class="btn btn-primary btn-sm" style="width: 100%; margin-top: 1rem;">Start Quiz</a>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <a href="{% url 'quiz:quiz_list' %}" class="btn btn-secondary">View All Quizzes</a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Daily Progress -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3>üìÖ Daily Progress</h3>
            </div>
            <div class="card-body">
                {% if daily_progress %}
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Attempts</th>
                                <th>Passed</th>
                                <th>Failed</th>
                                <th>Avg %</th>
                                <th>Time Spent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dp in daily_progress %}
                            <tr>
                                <td>{{ dp.date|date:"M d, Y" }}</td>
                                <td>{{ dp.quizzes_attempted }}</td>
                                <td style="color: var(--success);">{{ dp.quizzes_passed }}</td>
                                <td style="color: var(--danger);">{{ dp.quizzes_failed }}</td>
                                <td><strong>{{ dp.average_percentage|floatformat:1 }}%</strong></td>
                                <td>{{ dp.time_spent|floatformat:0 }}s</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 2rem; color: #6b7280;">
                    <p>No progress data yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_dates|safe }},
            datasets: [{
                label: 'Average Score %',
                data: {{ chart_percentages|safe }},
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
</script>
{% endblock %}